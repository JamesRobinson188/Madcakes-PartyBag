{% extends 'PartyBag/base.html' %}
{% block content %}
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Anton&family=Atma:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* --- Order Lookup (scoped) --- */
    .order-lookup {
      max-width: 980px;
      margin: 4vh auto;
      background: #fff4e6;
      border-radius: 14px;
      box-shadow: 0 6px 14px rgba(0,0,0,.08);
      padding: 3vh 4vw;
    }
    .order-lookup h1 {
      font-family: 'Anton', sans-serif;
      letter-spacing: .5px;
      margin: 0 0 1rem 0;
    }
    .order-lookup p.lead { color:#555; margin: 0 0 1.25rem 0; }

    .order-form { display:flex; flex-wrap:wrap; gap: 1rem; align-items:flex-end; }
    .order-form > div { flex:1; min-width:220px; }
    .order-form label { font-weight:700; display:block; margin-bottom:.25rem; }
    .order-form input[type="text"], .order-form input[type="email"] {
      width:100%;
      font-family: 'Atma', system-ui;
      font-size: 2.2vh;
      border: 2px solid #ffd4bd;
      background:#fff;
      border-radius: 10px;
      padding: .9rem .9rem;
      outline: none;
      transition: box-shadow .2s, border-color .2s;
    }
    .order-form input:focus { border-color:#ff6f61; box-shadow: 0 0 0 3px rgba(255,111,97,.15); }
    .order-form button {
      font-weight:700; border:none; cursor:pointer; border-radius: 10px; padding: 1rem 1.25rem;
      background: linear-gradient(90deg,#ff7ab6,#ffa94d); color:#fff; box-shadow: 0 6px 12px rgba(255,122,182,.25);
      margin-top:1.75rem;
    }
    .order-form button:hover { filter: brightness(1.02); }

    .helper { font-size: 1.9vh; color:#666; }
    .helper a { color:#aa3a72; text-decoration: underline; }

    .flash-container { margin: 1rem auto; max-width: 800px; }
    .flash { padding: 0.75rem 1rem; border-radius: 4px; margin-bottom: 0.5rem; font-weight: 500; }
    .flash-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .flash-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }

    /* Results */
    .order-card { margin-top: 2rem; background:#fff; border-radius: 14px; padding: 1.5rem; box-shadow: 0 6px 16px rgba(0,0,0,.08); }
    .card-head { display:flex; justify-content:space-between; gap: 1rem; flex-wrap: wrap; align-items:center; }
    .order-id { display:flex; align-items:center; gap:.5rem; font-weight:800; }

    .badge { padding:.35rem .65rem; border-radius:999px; font-weight:800; font-size:.95rem; }

    /* NEW: received = green */
    .badge.received   { background:#e7f9ec; color:#257a3e; border:1px solid #b7efc5; }

    /* processing = blue */
    .badge.processing { background:#eef4ff; color:#183a8a; border:1px solid #c4d7ff; }

    /* shipped = orange */
    .badge.shipped    { background:#fff6e6; color:#8a5200; border:1px solid #ffd699; }


    .meta { display:grid; grid-template-columns: repeat(2,1fr); gap: .75rem 1.5rem; margin-top: .75rem; }
    .meta div { background:#fffaf5; border:1px solid #ffe1cf; border-radius: 10px; padding: .65rem .8rem; }
    .meta .label { font-weight:700; margin-right:.35rem; color:#444; }

    table.items { width:100%; border-collapse: collapse; margin-top: 1rem; }
    table.items th, table.items td { text-align:left; padding:.75rem; }
    table.items thead th { background:#fff4e6; border-bottom:2px solid #ffd4bd; }
    table.items tbody td { border-bottom:1px dashed #ffe1cf; }
    .right { text-align:right; }

    .total-row td { font-weight:800; }
    .disclaimer { font-size: 1.7vh; color:#777; margin-top:.5rem; }

    .next-steps { margin-top:1rem; background:#fffaf5; border:1px solid #ffe1cf; border-radius: 12px; padding: 1rem; }

    @media (max-width: 820px) {
      .order-form { flex-direction:column; }
      .meta { grid-template-columns: 1fr; }
    }
  </style>
</head>

<div class="order-lookup">
  <h1>Track Your Order ðŸšš</h1>
  <p class="lead">Enter the 8-character Order ID from your receipt and the email used at checkout.</p>

  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash flash-{{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
  {% endwith %}

  <form class="order-form" method="POST" action="{{ url_for('partybags.order_lookup') }}" novalidate>
    <div>
      <label for="order_id">Order ID</label>
      <input id="order_id" name="order_id" type="text" inputmode="latin" maxlength="8"
             placeholder="e.g. 4J9QX2KD" value="{{ preset_order_id|default('') }}"
             pattern="[A-Za-z0-9]{8}" required aria-describedby="orderIdHelp">
      <div id="orderIdHelp" class="helper">Exactly 8 letters/numbers. We auto-UPPERCASE it for you.</div>
    </div>

    <div>
      <label for="email">Email</label>
      <input id="email" name="email" type="email" placeholder="you@example.com" value="{{ preset_email|default('') }}" required>
      <div class="helper">Use the same email you entered on the checkout page.</div>
    </div>

    <div>
      <button type="submit">Check my order â†’</button>
    </div>
  </form>

  {% if result %}
    {% set status = (result.status or '')|lower %}
	{% set badge_class = 'badge ' + (
		'received' if status=='received' else (
		'processing' if status=='processing' else (
		'shipped' if status=='shipped' else ''
	))) %}


    <div class="order-card">
      <div class="card-head">
        <div class="order-id">
          <span>Order:</span>
          <strong>#{{ result.order_id }}</strong>
        </div>
        <div class="status">
          <span class="{{ badge_class }}">{{ result.status|title }}</span>
        </div>
      </div>

      <div class="meta" role="group" aria-label="Order info">
        <div><span class="label">Placed:</span> {{ (result.created_at or '')[:10] }} </div>
        <div><span class="label">Email:</span> {{ result.email }}</div>
      </div>

      <table class="items" aria-label="Order items">
        <thead>
          <tr>
            <th>Item</th>
            <th class="right">Qty</th>
            <th class="right">Unit</th>
            <th class="right">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          {% for it in result['items'] %}
          <tr>
            <td>{{ it.name }}</td>
            <td class="right">{{ it.qty }}</td>
            <td class="right">{{ it.unit_amount_gbp }}</td>
            <td class="right">{{ it.subtotal_gbp }}</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="3" class="right">Items Total</td>
            <td class="right">{{ result.total_gbp }}</td>
          </tr>
        </tfoot>
      </table>
      <p class="disclaimer">* Delivery fee (if charged) may not be reflected in the items total shown above.</p>

      <div class="next-steps">
        {% if status == 'processing' %}
          <strong>Processing.</strong> Your order is being prepared.
        {% elif status == 'shipped' %}
          <strong>Shipped.</strong> Your order is on the way!
        {% else %}
          Want help? <a href="{{ url_for('partybags.contact') }}">Contact us</a> and quote your Order ID.
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>

<script>
  // Uppercase the order ID as the user types
  const orderInput = document.getElementById('order_id');
  if (orderInput) {
    orderInput.addEventListener('input', () => {
      orderInput.value = orderInput.value.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 8);
    });
  }
</script>
{% endblock %}
