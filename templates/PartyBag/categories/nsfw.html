{% extends 'PartyBag/base.html' %}

{% block content %}
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='PartyBag/categories.css') }}">
    {% if show_age_gate %}
        <style>
            :root {
                --c-bg: #ffffff;
                --c-cream: #fff7ec;
                --c-border: #e8dccb;
                --c-text: #2b211e;
                --c-cocoa: #3b2a26;
                --c-cocoa-dark: #2f221e;
                --c-gold: #c9a15b;
                --radius-xl: 20px;
                --shadow-lg: 0 18px 42px rgba(0, 0, 0, .12);
            }
            #ageModal {
                position: fixed;
                inset: 0;
                display: none;
                align-items: center;
                justify-content: center;
                background: rgba(20, 14, 12, .55);
                backdrop-filter: blur(20px) saturate(0.9) brightness(0.95);
                z-index: 9999;
            }
            #ageModal.is-open {
                display: flex;
            }
            #ageModalContent {
                width: min(92vw, 420px);
                background: var(--c-bg);
                border: 1px solid var(--c-border);
                border-radius: var(--radius-xl);
                box-shadow: var(--shadow-lg);
                padding: 1.25rem 1.25rem 1.35rem;
                text-align: center;
            }
            #ageModalContent h2 {
                margin: 0 0 .4rem;
                color: var(--c-cocoa-dark);
            }
            #dob, #dobSubmit {
                width: 100%;
                padding: .7rem .8rem;
                font-size: 1rem;
                border-radius: 12px;
                border: 1px solid var(--c-border);
            }
            #dobSubmit {
                margin-top: .7rem;
                font-weight: 700;
                cursor: pointer;
                background: linear-gradient(180deg, #fff, #fff8ef);
                color: var(--c-cocoa);
                border-color: var(--c-gold);
                box-shadow: 0 10px 24px rgba(201, 161, 91, .18);
                transition: transform .12s ease, filter .2s ease;
            }
            #dobSubmit:hover {
                transform: translateY(-1px);
                filter: brightness(.98);
            }
            #ageError {
                color: #c00;
                margin-top: .5rem;
                min-height: 1.2em;
            }
        </style>
    {% endif %}
</head>

{% if show_age_gate %}
<div id="ageModal" role="dialog" aria-modal="true" aria-labelledby="ageTitle">
    <div id="ageModalContent">
        <h2 id="ageTitle">Age Verification</h2>
        <p>Please enter your date of birth to continue (DD/MM/YYYY):</p>
        <input type="text" id="dob" placeholder="DD/MM/YYYY" inputmode="numeric" autocomplete="bday" aria-describedby="ageError">
        <div id="ageError" role="status" aria-live="polite"></div>
        <button id="dobSubmit">Submit</button>
    </div>
</div>
{% endif %}

<h1>NSFW bags</h1>
<h2>Lots of super secret stuff</h2>

{% if products %}
    {% for subcat, items in products|groupby('subcategory') %}
        <hr class="section-divider">
        <h2 class="subcategory-title">{{ subcat or 'Uncategorized' }}</h2>
        <div class="extras-grid">
            {% for product in items %}
                <div class="category-card extras-card">
                    <a href="{{ url_for('partybags.product', product_id=product.id) }}">
                        {% if product.image %}
                            <img src="{{ url_for('static', filename=product.image) }}" alt="{{ product.name }}" width="220" height="220">
                        {% else %}
                            <img src="{{ url_for('static', filename='imgs/no_image.png') }}" alt="No image" width="220" height="220">
                        {% endif %}
                        <p>{{ product.name }}</p>
                        <p>£{{ product.price }}</p>
                    </a>
                    {% if product.stock > 0 %}
                        <form action="{{ url_for('partybags.add_to_cart', product_id=product.id) }}" method="POST">
                            <input type="hidden" name="quantity" value="1">
                            <button type="submit">Add to Cart</button>
                        </form>
                    {% else %}
                        <p style="color:red;">Out of stock</p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endfor %}
{% else %}
    <div class="row-of-whatever">
        <h1>No NSFW bags are available right now - please check back soon!</h1>
    </div>
{% endif %}

{% if show_age_gate %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const ageModal = document.getElementById('ageModal');
    if (!ageModal) return;

    // Show the modal immediately (server says gate required)
    ageModal.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    const dobField = document.getElementById('dob');
    const errorEl = document.getElementById('ageError');
    const submitBtn = document.getElementById('dobSubmit');

    const toUkIfIso = (v) => /^\d{4}-\d{2}-\d{2}$/.test(v) ? v.split('-').reverse().join('/') : v;
    const normalizeUk = (v) => {
        v = v.replace(/[.\- ]/g, '/').trim();
        if (/^\d{8}$/.test(v)) v = v.slice(0, 2) + '/' + v.slice(2, 4) + '/' + v.slice(4);
        return v;
    };
    const validUk = (v) => {
        if (!/^\d{2}\/\d{2}\/\d{4}$/.test(v)) return false;
        const [d, m, y] = v.split('/').map(n => parseInt(n, 10));
        if (y < 1900 || y > new Date().getFullYear()) return false;
        if (m < 1 || m > 12) return false;
        const js = new Date(y, m - 1, d);
        return js.getFullYear() === y && js.getMonth() === m - 1 && js.getDate() === d;
    };

    dobField.addEventListener('blur', () => {
        let v = normalizeUk(dobField.value);
        v = toUkIfIso(v);
        dobField.value = v;
    });
    dobField.addEventListener('input', () => errorEl.textContent = '');

    submitBtn.addEventListener('click', async () => {
        errorEl.textContent = '';
        let value = normalizeUk(dobField.value);
        value = toUkIfIso(value);
        dobField.value = value;

        if (!validUk(value)) {
            errorEl.textContent = 'Please enter your date in DD/MM/YYYY format.';
            return;
        }

        try {
            const r = await fetch('/age/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dob: value })
            });
            if (r.ok) {
                // Optional: convenience for client-only checks (not required anymore)
                localStorage.setItem('dobVerified', 'true');
                ageModal.style.display = 'none';
                document.body.style.overflow = '';
            } else {
                const j = await r.json().catch(() => ({}));
                errorEl.textContent = j.error === 'underage'
                    ? 'Sorry, you must be 18 or older to view this content.'
                    : 'That date didn’t look right—please try again.';
            }
        } catch (e) {
            errorEl.textContent = 'Network error—please try again.';
        }
    });
});
</script>
{% endif %}
{% endblock %}
